<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ ch∆°i: Si√™u Sao M√°y T√≠nh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Baloo 2', cursive;
            touch-action: none;
        }
        .draggable-item {
            touch-action: none;
        }
        .drop-zone {
            border: 2px dashed #a78bfa;
            min-height: 60px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .drop-zone.over {
            background-color: #d8b4fe;
            border-color: #8b5cf6;
        }
        .feedback-correct {
            animation: correct-animation 0.5s ease-in-out;
        }
        .feedback-incorrect {
            animation: incorrect-animation 0.5s ease-in-out;
        }
        @keyframes correct-animation {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes incorrect-animation {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #f00;
            opacity: 0.7;
            border-radius: 50%;
            animation: fall 3s linear infinite;
        }
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        .modal {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-200 via-violet-300 to-sky-300 min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="w-full max-w-3xl mx-auto bg-white/90 backdrop-blur-sm rounded-3xl shadow-2xl p-6 md:p-8 text-center text-gray-800 relative overflow-hidden">
        <div id="confetti-container"></div>
        <!-- M√†n h√¨nh b·∫Øt ƒë·∫ßu -->
        <div id="start-screen">
            <h1 class="text-4xl md:text-6xl font-bold text-violet-600 mb-4 drop-shadow-lg">üíª Si√™u Sao M√°y T√≠nh üèÜ</h1>
            <p class="text-lg md:text-xl mb-8">C√πng kh√°m ph√° th·∫ø gi·ªõi sao ch√©p v√† di chuy·ªÉn th∆∞ m·ª•c nh√©!</p>
            <button id="start-button" class="bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transform hover:scale-105 transition-transform duration-300">
                B·∫Øt ƒë·∫ßu!
            </button>
        </div>

        <!-- M√†n h√¨nh h∆∞·ªõng d·∫´n -->
        <div id="instructions-screen" class="hidden">
            <h2 class="text-3xl font-bold text-amber-500 mb-4">üí° H∆∞·ªõng d·∫´n üí°</h2>
            <div class="text-left text-lg space-y-4 mx-auto max-w-lg">
                <p>‚úîÔ∏è V·ªõi c√¢u h·ªèi <strong>tr·∫Øc nghi·ªám</strong>, h√£y ch·ªçn ƒë√°p √°n m√† b·∫°n tin l√† ƒë√∫ng nh·∫•t.</p>
                <p>‚úîÔ∏è V·ªõi c√¢u h·ªèi <strong>k√©o th·∫£</strong>, h√£y k√©o c√°c b∆∞·ªõc v√†o ƒë√∫ng √¥ th·ª© t·ª±.</p>
                <p>üí° Sau khi tr·∫£ l·ªùi, b√© c√≥ th·ªÉ nh·∫•n n√∫t <strong>"Xem gi·∫£i th√≠ch"</strong> ƒë·ªÉ hi·ªÉu b√†i r√µ h∆°n.</p>
                <p>üéµ L·∫Øng nghe √¢m thanh ƒë·ªÉ bi·∫øt c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n ƒë√∫ng hay sai!</p>
            </div>
            <button id="play-button" class="mt-8 bg-gradient-to-r from-pink-500 to-yellow-500 hover:from-pink-600 hover:to-yellow-600 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transform hover:scale-105 transition-transform duration-300">
                V√†o ch∆°i th√¥i!
            </button>
        </div>

        <!-- M√†n h√¨nh tr√≤ ch∆°i -->
        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <div id="progress-text" class="text-lg font-semibold bg-white/50 rounded-full px-4 py-1">C√¢u 1/8</div>
                <div id="score-text" class="text-lg font-semibold bg-white/50 rounded-full px-4 py-1">ƒêi·ªÉm: 0</div>
            </div>
            <div id="question-container" class="bg-violet-50 p-6 rounded-2xl shadow-inner">
                <h2 id="question-text" class="text-xl md:text-2xl font-bold mb-6 min-h-[80px]"></h2>
                <div id="answer-options" class="space-y-4"></div>
                <div id="drag-drop-container" class="hidden mt-4 md:flex md:space-x-4">
                    <div id="draggable-items" class="w-1/2 space-y-3 p-2 bg-gray-100 rounded-lg"></div>
                    <div id="drop-zones" class="w-1/2 space-y-3"></div>
                </div>
                 <div id="drag-drop-container-mobile" class="hidden mt-4 md:hidden">
                    <p class="mb-2 font-semibold">K√©o c√°c b∆∞·ªõc v√†o ƒë√∫ng th·ª© t·ª±:</p>
                    <div id="drop-zones-mobile" class="space-y-3 mb-4"></div>
                    <p class="mb-2 font-semibold">C√°c b∆∞·ªõc:</p>
                    <div id="draggable-items-mobile" class="space-y-3 p-2 bg-gray-100 rounded-lg"></div>
                </div>
            </div>
            <div id="navigation-buttons" class="mt-6 flex justify-center items-center gap-4 h-12">
                 <button id="check-drag-button" class="hidden bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-6 rounded-full text-lg shadow-lg">Ki·ªÉm tra</button>
                 <button id="explanation-button" class="hidden bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-6 rounded-full text-lg shadow-lg">üí° Xem gi·∫£i th√≠ch</button>
                 <button id="next-question-button" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full text-lg shadow-lg">C√¢u ti·∫øp theo ‚û°Ô∏è</button>
            </div>
        </div>

        <!-- M√†n h√¨nh k·∫øt th√∫c -->
        <div id="end-screen" class="hidden">
            <h2 class="text-4xl font-bold text-green-500 mb-4 drop-shadow-md">üéâ Ch√∫c M·ª´ng! üéâ</h2>
            <p class="text-2xl mb-2">B√© ƒë√£ tr·ªü th√†nh m·ªôt Si√™u Sao M√°y T√≠nh!</p>
            <p class="text-2xl mb-2">T·ªïng ƒëi·ªÉm c·ªßa b·∫°n l√†:</p>
            <p id="final-score" class="text-7xl font-bold text-violet-600 my-4 drop-shadow-lg">0</p>
            <button id="restart-button" class="bg-gradient-to-r from-green-400 to-blue-500 hover:from-green-500 hover:to-blue-600 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg transform hover:scale-105 transition-transform duration-300">
                Ch∆°i l·∫°i
            </button>
        </div>
    </div>

    <!-- Explanation Modal -->
    <div id="explanation-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 relative">
            <button id="close-explanation-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            <h3 class="text-2xl font-bold text-violet-600 mb-4">üí° L·ªùi gi·∫£i th√≠ch üí°</h3>
            <div id="explanation-text" class="text-left text-lg max-h-[60vh] overflow-y-auto pr-2"></div>
        </div>
    </div>

    <script>
        // --- Game Configuration ---
        const questions = [
            // --- TR·∫ÆC NGHI·ªÜM ---
            {
                type: 'mcq',
                question: 'üíñ ƒê·ªÉ sao ch√©p m·ªôt th∆∞ m·ª•c, sau khi ch·ªçn th∆∞ m·ª•c ƒë√≥, b·∫°n c·∫ßn nh·∫•n v√†o l·ªánh n√†o?',
                options: ['‚úÇÔ∏è Cut', 'üìã Copy', 'üóëÔ∏è Delete', 'üìù Rename'],
                answer: 1,
                explanation: 'Sau khi ch·ªçn th∆∞ m·ª•c c·∫ßn sao ch√©p, b∆∞·ªõc ti·∫øp theo l√† nh·∫•n chu·ªôt v√†o n√∫t l·ªánh <strong>Copy</strong> (ho·∫∑c t·ªï h·ª£p ph√≠m <strong>Ctrl + C</strong>). L·ªánh n√†y s·∫Ω t·∫°o ra m·ªôt b·∫£n sao trong b·ªô nh·ªõ c·ªßa m√°y t√≠nh, s·∫µn s√†ng ƒë·ªÉ d√°n ra ·ªü n∆°i kh√°c.'
            },
            {
                type: 'mcq',
                question: '‚≠ê Sau khi sao ch√©p m·ªôt t·ªáp tin, ƒë·ªÉ d√°n t·ªáp tin ƒë√≥ v√†o th∆∞ m·ª•c m·ªõi, b·∫°n s·∫Ω s·ª≠ d·ª•ng t·ªï h·ª£p ph√≠m t·∫Øt n√†o?',
                options: ['‚å®Ô∏è Ctrl + X', '‚å®Ô∏è Ctrl + C', '‚å®Ô∏è Ctrl + A', '‚å®Ô∏è Ctrl + V'],
                answer: 3,
                explanation: 'ƒê·ªÉ d√°n ƒë·ªëi t∆∞·ª£ng ƒë√£ ƒë∆∞·ª£c sao ch√©p v√†o th∆∞ m·ª•c ƒë√≠ch, ch√∫ng ta c·∫ßn nh·∫•n chu·ªôt v√†o n√∫t l·ªánh <strong>Paste</strong> ho·∫∑c s·ª≠ d·ª•ng t·ªï h·ª£p ph√≠m <strong>Ctrl + V</strong>. Gi·ªëng nh∆∞ d√πng h·ªì d√°n ƒë·ªÉ d√°n m·ªôt h√¨nh ·∫£nh v√†o v·ªü v·∫≠y ƒë√≥ b√©!'
            },
            {
                type: 'mcq',
                question: 'ƒê·ªÉ "chuy·ªÉn nh√†" cho m·ªôt th∆∞ m·ª•c (di chuy·ªÉn), sau khi ch·ªçn th∆∞ m·ª•c ƒë√≥, b√© s·∫Ω s·ª≠ d·ª•ng t·ªï h·ª£p ph√≠m t·∫Øt n√†o sau ƒë√¢y? üöÄ',
                options: ['Ctrl + C', 'Ctrl + X', 'Ctrl + V', 'Ctrl + A'],
                answer: 1,
                explanation: 'L·ªánh <strong>Cut</strong> v·ªõi t·ªï h·ª£p ph√≠m <strong>Ctrl + X</strong> ƒë∆∞·ª£c d√πng ƒë·ªÉ c·∫Øt m·ªôt th∆∞ m·ª•c ho·∫∑c t·ªáp kh·ªèi v·ªã tr√≠ hi·ªán t·∫°i, chu·∫©n b·ªã cho vi·ªác di chuy·ªÉn n√≥ ƒë·∫øn m·ªôt n∆°i m·ªõi. N√≥ gi·ªëng nh∆∞ m√¨nh b∆∞ng m·ªôt m√≥n ƒë·ªì ƒëi ch·ªó kh√°c v·∫≠y, m√≥n ƒë·ªì s·∫Ω kh√¥ng c√≤n ·ªü ch·ªó c≈© n·ªØa.'
            },
            {
                type: 'mcq',
                question: 'Sau khi b·∫°n An th·ª±c hi·ªán th√†nh c√¥ng thao t√°c di chuy·ªÉn th∆∞ m·ª•c Truyen t·ª´ th∆∞ m·ª•c Lop 4A sang th∆∞ m·ª•c Luu tru, ƒëi·ªÅu g√¨ s·∫Ω x·∫£y ra v·ªõi th∆∞ m·ª•c Truyen ·ªü trong th∆∞ m·ª•c Lop 4A? ü§î',
                options: ['Th∆∞ m·ª•c v·∫´n c√≤n ·ªü th∆∞ m·ª•c Lop 4A.', 'Th∆∞ m·ª•c ƒë∆∞·ª£c nh√¢n ƒë√¥i ·ªü c·∫£ hai n∆°i.', 'Th∆∞ m·ª•c bi·∫øn m·∫•t kh·ªèi th∆∞ m·ª•c Lop 4A.', 'Th∆∞ m·ª•c b·ªã x√≥a vƒ©nh vi·ªÖn.'],
                answer: 2,
                explanation: 'Khi di chuy·ªÉn (Cut v√† Paste), th∆∞ m·ª•c g·ªëc s·∫Ω kh√¥ng c√≤n t·ªìn t·∫°i ·ªü v·ªã tr√≠ c≈© n·ªØa m√† ch·ªâ xu·∫•t hi·ªán ·ªü th∆∞ m·ª•c ƒë√≠ch th√¥i nh√©! N√≥ ƒë√£ "chuy·ªÉn nh√†" th·∫≠t s·ª± r·ªìi ƒë√≥.'
            },
            // --- K√âO TH·∫¢ ---
            {
                type: 'drag_drop',
                question: 'H√£y s·∫Øp x·∫øp c√°c b∆∞·ªõc sau ƒë√¢y theo ƒë√∫ng th·ª© t·ª± ƒë·ªÉ sao ch√©p th∆∞ m·ª•c "Tin hoc" t·ª´ th∆∞ m·ª•c "Lop 4A" sang th∆∞ m·ª•c "Luu tru" nh√©!',
                items: [
                    { id: 'c3_a', text: 'M·ªü th∆∞ m·ª•c ƒë√≠ch "Luu tru".', style: 'background-color:#FFF8E1; border-left: 5px solid #FFC107;' },
                    { id: 'c3_b', text: 'Ch·ªçn th∆∞ m·ª•c "Tin hoc" c·∫ßn sao ch√©p.', style: 'background-color:#E3F2FD; border-left: 5px solid #2196F3;' },
                    { id: 'c3_c', text: 'M·ªü th∆∞ m·ª•c ngu·ªìn "Lop 4A".', style: 'background-color:#E8F5E9; border-left: 5px solid #4CAF50;' },
                    { id: 'c3_d', text: 'Nh·∫•n l·ªánh Paste (ho·∫∑c Ctrl + V).', style: 'background-color:#FCE4EC; border-left: 5px solid #E91E63;' }
                ],
                correctOrder: ['c3_c', 'c3_b', 'c3_a', 'c3_d'],
                explanation: 'Quy tr√¨nh ƒë√∫ng l√†: <strong>1. M·ªü th∆∞ m·ª•c ngu·ªìn "Lop 4A"</strong> (ƒë·∫øn n∆°i ch·ª©a ƒë·ªì) ‚Üí <strong>2. Ch·ªçn th∆∞ m·ª•c "Tin hoc"</strong> (ch·ªçn m√≥n ƒë·ªì) ‚Üí <strong>3. M·ªü th∆∞ m·ª•c ƒë√≠ch "Luu tru"</strong> (ƒëi ƒë·∫øn n∆°i mu·ªën c·∫•t) ‚Üí <strong>4. Nh·∫•n l·ªánh Paste</strong> (ƒë·∫∑t m√≥n ƒë·ªì v√†o).'
            },
            {
                type: 'drag_drop_fill',
                question: 'H√£y k√©o c√°c l·ªánh v√† ph√≠m t·∫Øt v√†o ƒë√∫ng quy tr√¨nh 4 b∆∞·ªõc ƒë·ªÉ ho√†n th√†nh vi·ªác sao ch√©p.',
                base: [
                    { text: 'B∆∞·ªõc 1: M·ªü th∆∞ m·ª•c ngu·ªìn v√† ch·ªçn th∆∞ m·ª•c c·∫ßn ch√©p.' },
                    { text: 'B∆∞·ªõc 2:', drop: true, correctId: 'c4_copy' },
                    { text: 'B∆∞·ªõc 3: M·ªü th∆∞ m·ª•c ƒë√≠ch.' },
                    { text: 'B∆∞·ªõc 4:', drop: true, correctId: 'c4_paste' }
                ],
                items: [
                    { id: 'c4_paste', text: 'Nh·∫•n chu·ªôt v√†o n√∫t l·ªánh Paste (ho·∫∑c g√µ t·ªï h·ª£p ph√≠m Ctrl + V).', style: 'background-color:#E0F7FA; border-left: 5px solid #00BCD4;' },
                    { id: 'c4_copy', text: 'Nh·∫•n chu·ªôt v√†o n√∫t l·ªánh Copy (ho·∫∑c g√µ t·ªï h·ª£p ph√≠m Ctrl + C).', style: 'background-color:#F3E5F5; border-left: 5px solid #9C27B0;' }
                ],
                explanation: 'Sau khi ch·ªçn th∆∞ m·ª•c (B∆∞·ªõc 1), ch√∫ng ta ph·∫£i d√πng l·ªánh <strong>Copy (Ctrl + C)</strong> ƒë·ªÉ sao ch√©p n√≥ (B∆∞·ªõc 2). Sau ƒë√≥, khi ƒë√£ ·ªü th∆∞ m·ª•c ƒë√≠ch (B∆∞·ªõc 3), ch√∫ng ta d√πng l·ªánh <strong>Paste (Ctrl + V)</strong> ƒë·ªÉ d√°n n√≥ ra (B∆∞·ªõc 4).'
            },
            {
                type: 'drag_drop',
                question: 'üåü B√© h√£y th·∫≠t kh√©o l√©o k√©o th·∫£ c√°c b∆∞·ªõc d∆∞·ªõi ƒë√¢y ƒë·ªÉ s·∫Øp x·∫øp ƒë√∫ng th·ª© t·ª± 4 b∆∞·ªõc ch√≠nh ƒë·ªÉ di chuy·ªÉn th∆∞ m·ª•c "Truyen" nh√©!',
                items: [
                    { id: 'c7_a', text: 'M·ªü th∆∞ m·ª•c Luu tru (th∆∞ m·ª•c ƒë√≠ch).', style: 'background-color:#FFF8E1; border-left: 5px solid #FFC107;' },
                    { id: 'c7_b', text: 'Ch·ªçn th∆∞ m·ª•c Truyen v√† nh√°y v√†o n√∫t l·ªánh Cut (ho·∫∑c nh·∫•n Ctrl + X).', style: 'background-color:#E3F2FD; border-left: 5px solid #2196F3;' },
                    { id: 'c7_c', text: 'Nh√°y v√†o n√∫t l·ªánh Paste (ho·∫∑c nh·∫•n Ctrl + V) ƒë·ªÉ d√°n th∆∞ m·ª•c v√†o.', style: 'background-color:#FCE4EC; border-left: 5px solid #E91E63;' },
                    { id: 'c7_d', text: 'M·ªü th∆∞ m·ª•c Lop 4A (th∆∞ m·ª•c ngu·ªìn).', style: 'background-color:#E8F5E9; border-left: 5px solid #4CAF50;' }
                ],
                correctOrder: ['c7_d', 'c7_b', 'c7_a', 'c7_c'],
                explanation: 'ƒê·ªÉ "chuy·ªÉn nh√†" cho th∆∞ m·ª•c, b√© c·∫ßn: <strong>1. M·ªü th∆∞ m·ª•c ngu·ªìn "Lop 4A"</strong> (ƒë·∫øn nh√† c≈©) ‚Üí <strong>2. Ch·ªçn th∆∞ m·ª•c "Truyen" v√† Cut</strong> (ƒë√≥ng g√≥i ƒë·ªì ƒë·∫°c) ‚Üí <strong>3. M·ªü th∆∞ m·ª•c ƒë√≠ch "Luu tru"</strong> (ƒëi ƒë·∫øn nh√† m·ªõi) ‚Üí <strong>4. Nh·∫•n l·ªánh Paste</strong> (d·ªçn ƒë·ªì v√†o nh√† m·ªõi).'
            },
             {
                type: 'drag_drop',
                question: 'üè° Th·ª≠ t√†i tr√≠ nh·ªõ c·ªßa b√© n√†o! H√£y s·∫Øp x·∫øp l·∫°i quy tr√¨nh "d·ªçn nh√†" cho m·ªôt t·ªáp tin t·ª´ th∆∞ m·ª•c n√†y sang th∆∞ m·ª•c kh√°c.',
                items: [
                    { id: 'c8_a', text: 'ƒêi ƒë·∫øn "ng√¥i nh√† m·ªõi" (th∆∞ m·ª•c ƒë√≠ch).', style: 'background-color:#FFF3E0; border-left: 5px solid #FF9800;' },
                    { id: 'c8_b', text: 'Ch·ªçn t·ªáp tin mu·ªën di chuy·ªÉn v√† d√πng l·ªánh Cut.', style: 'background-color:#F3E5F5; border-left: 5px solid #9C27B0;' },
                    { id: 'c8_c', text: 'D√°n t·ªáp tin v√†o nh√† m·ªõi b·∫±ng l·ªánh Paste.', style: 'background-color:#E0F7FA; border-left: 5px solid #00BCD4;' },
                    { id: 'c8_d', text: 'M·ªü "ng√¥i nh√† c≈©" (th∆∞ m·ª•c ngu·ªìn).', style: 'background-color:#F1F8E9; border-left: 5px solid #8BC34A;' }
                ],
                correctOrder: ['c8_d', 'c8_b', 'c8_a', 'c8_c'],
                explanation: 'Quy tr√¨nh "d·ªçn nh√†" cho t·ªáp tin r·∫•t ƒë∆°n gi·∫£n: <strong>1. M·ªü "nh√† c≈©"</strong> ‚Üí <strong>2. D√πng l·ªánh Cut ƒë·ªÉ "b∆∞ng" t·ªáp tin ƒëi</strong> ‚Üí <strong>3. ƒêi ƒë·∫øn "nh√† m·ªõi"</strong> ‚Üí <strong>4. D√πng l·ªánh Paste ƒë·ªÉ "ƒë·∫∑t" t·ªáp tin v√†o.</strong>'
            }
        ];

        // --- Game Variables ---
        let currentQuestionIndex = 0;
        let score = 0;
        let synth;

        // --- DOM Elements ---
        const allScreens = {
            start: document.getElementById('start-screen'),
            instructions: document.getElementById('instructions-screen'),
            game: document.getElementById('game-screen'),
            end: document.getElementById('end-screen')
        };
        const startButton = document.getElementById('start-button');
        const playButton = document.getElementById('play-button');
        const restartButton = document.getElementById('restart-button');
        const progressText = document.getElementById('progress-text');
        const scoreText = document.getElementById('score-text');
        const questionText = document.getElementById('question-text');
        const answerOptions = document.getElementById('answer-options');
        const finalScore = document.getElementById('final-score');
        const dragDropContainer = document.getElementById('drag-drop-container');
        const draggableItemsContainer = document.getElementById('draggable-items');
        const dropZonesContainer = document.getElementById('drop-zones');
        const checkDragButton = document.getElementById('check-drag-button');
        const dragDropContainerMobile = document.getElementById('drag-drop-container-mobile');
        const draggableItemsContainerMobile = document.getElementById('draggable-items-mobile');
        const dropZonesContainerMobile = document.getElementById('drop-zones-mobile');
        const confettiContainer = document.getElementById('confetti-container');
        const explanationButton = document.getElementById('explanation-button');
        const nextQuestionButton = document.getElementById('next-question-button');
        const explanationModal = document.getElementById('explanation-modal');
        const closeExplanationModal = document.getElementById('close-explanation-modal');
        const explanationText = document.getElementById('explanation-text');

        // --- Audio Handling ---
        function setupAudio() {
            if (!synth) {
                synth = new Tone.Synth().toDestination();
            }
        }

        function playSound(isCorrect) {
            if (!synth) return;
            Tone.start();
            if (isCorrect) {
                synth.triggerAttackRelease("C5", "8n", Tone.now());
                synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.1);
            } else {
                synth.triggerAttackRelease("A2", "8n");
            }
        }
        
        // --- Screen Management ---
        function showScreen(screenName) {
            Object.values(allScreens).forEach(screen => screen.classList.add('hidden'));
            allScreens[screenName].classList.remove('hidden');
        }

        // --- Game Logic ---
        function startGame() {
            showScreen('game');
            currentQuestionIndex = 0;
            score = 0;
            updateScore();
            loadQuestion();
        }

        function loadQuestion() {
            if (currentQuestionIndex >= questions.length) {
                showEndScreen();
                return;
            }

            progressText.textContent = `C√¢u ${currentQuestionIndex + 1}/${questions.length}`;
            const currentQuestion = questions[currentQuestionIndex];
            questionText.innerHTML = currentQuestion.question;

            // Cleanup
            answerOptions.innerHTML = '';
            dragDropContainer.classList.add('hidden');
            dragDropContainerMobile.classList.add('hidden');
            checkDragButton.classList.add('hidden');
            explanationButton.classList.add('hidden');
            nextQuestionButton.classList.add('hidden');

            if (currentQuestion.type === 'mcq') {
                answerOptions.classList.remove('hidden');
                currentQuestion.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.innerHTML = option;
                    button.classList.add('w-full', 'bg-white', 'p-4', 'rounded-xl', 'shadow-md', 'text-left', 'hover:bg-violet-100', 'transition-colors', 'duration-200', 'border-2', 'border-transparent', 'text-lg');
                    button.onclick = () => selectAnswer(index, button);
                    answerOptions.appendChild(button);
                });
            } else if (currentQuestion.type === 'drag_drop' || currentQuestion.type === 'drag_drop_fill') {
                answerOptions.classList.add('hidden');
                setupDragDrop(currentQuestion);
            }
        }
        
        function showPostAnswerButtons() {
            explanationButton.classList.remove('hidden');
            nextQuestionButton.classList.remove('hidden');
        }

        function selectAnswer(selectedIndex, button) {
            const isCorrect = selectedIndex === questions[currentQuestionIndex].answer;
            Array.from(answerOptions.children).forEach(btn => btn.disabled = true);

            if (isCorrect) {
                score += 10;
                playSound(true);
                button.classList.add('bg-green-400', 'text-white', 'border-green-600', 'feedback-correct');
            } else {
                playSound(false);
                button.classList.add('bg-red-400', 'text-white', 'border-red-600', 'feedback-incorrect');
                const correctButton = answerOptions.children[questions[currentQuestionIndex].answer];
                correctButton.classList.add('bg-green-400', 'text-white', 'border-green-600');
            }
            updateScore();
            showPostAnswerButtons();
        }

        // --- Drag and Drop Logic ---
        let draggedItem = null;
        let clone = null;

        function setupDragDrop(question) {
            if (question.type === 'drag_drop_fill') {
                setupDragDropFillForView(question, draggableItemsContainer, dropZonesContainer, dragDropContainer);
                setupDragDropFillForView(question, draggableItemsContainerMobile, dropZonesContainerMobile, dragDropContainerMobile);
            } else {
                setupDragDropForView(question, draggableItemsContainer, dropZonesContainer, dragDropContainer);
                setupDragDropForView(question, draggableItemsContainerMobile, dropZonesContainerMobile, dragDropContainerMobile);
            }
            checkDragButton.classList.remove('hidden');
        }

        function createDraggableItem(item) {
            const div = document.createElement('div');
            div.id = item.id;
            div.innerHTML = item.text;
            div.draggable = true;
            div.style.cssText = item.style;
            div.classList.add('p-3', 'rounded-lg', 'shadow', 'cursor-move', 'draggable-item');
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('touchstart', handleTouchStart, { passive: false });
            div.addEventListener('touchmove', handleTouchMove, { passive: false });
            div.addEventListener('touchend', handleTouchEnd);
            return div;
        }

        function createDropZone(index, placeholderText) {
            const zone = document.createElement('div');
            zone.classList.add('p-4', 'rounded-lg', 'drop-zone', 'flex', 'items-center', 'justify-center');
            zone.dataset.order = index;
            zone.innerHTML = `<span class="text-gray-400">${placeholderText}</span>`;
            zone.addEventListener('dragover', handleDragOver);
            zone.addEventListener('dragleave', handleDragLeave);
            zone.addEventListener('drop', handleDrop);
            return zone;
        }

        function setupDragDropForView(question, draggableContainer, dropZoneContainer, mainContainer) {
            draggableContainer.innerHTML = '';
            dropZoneContainer.innerHTML = '';
            mainContainer.classList.remove('hidden');

            const shuffledItems = [...question.items].sort(() => Math.random() - 0.5);
            shuffledItems.forEach(item => {
                draggableContainer.appendChild(createDraggableItem(item));
            });

            question.items.forEach((_, index) => {
                dropZoneContainer.appendChild(createDropZone(index, `Th·ª© t·ª± ${index + 1}`));
            });
        }
        
        function setupDragDropFillForView(question, draggableContainer, dropZoneContainer, mainContainer) {
            draggableContainer.innerHTML = '';
            dropZoneContainer.innerHTML = '';
            mainContainer.classList.remove('hidden');

            question.items.forEach(item => {
                draggableContainer.appendChild(createDraggableItem(item));
            });

            question.base.forEach((step, index) => {
                const container = document.createElement('div');
                container.classList.add('text-left', 'p-3', 'bg-gray-100', 'rounded-lg');
                container.textContent = step.text;
                if (step.drop) {
                    const zone = createDropZone(index, 'K√©o v√†o ƒë√¢y');
                    zone.dataset.correctId = step.correctId;
                    container.appendChild(zone);
                }
                dropZoneContainer.appendChild(container);
            });
        }

        function handleDragStart(e) {
            draggedItem = e.target;
            e.dataTransfer.setData('text/plain', e.target.id);
            setTimeout(() => e.target.classList.add('opacity-50'), 0);
        }
        
        function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('over'); }
        function handleDragLeave(e) { e.currentTarget.classList.remove('over'); }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('over');
            const targetZone = e.currentTarget;

            if (targetZone.firstChild && targetZone.firstChild.classList.contains('draggable-item')) {
                const existingItem = targetZone.firstChild;
                const draggableContainer = targetZone.closest('.md\\:flex, .md\\:hidden').querySelector('[id^="draggable-items"]');
                draggableContainer.appendChild(existingItem);
            }
            
            draggedItem.classList.remove('opacity-50');
            targetZone.innerHTML = '';
            targetZone.appendChild(draggedItem);
            draggedItem = null;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            draggedItem = e.target;
            clone = draggedItem.cloneNode(true);
            clone.style.position = 'absolute';
            clone.style.zIndex = '1000';
            clone.style.opacity = '0.7';
            document.body.appendChild(clone);
            moveClone(e.touches[0].clientX, e.touches[0].clientY);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!draggedItem) return;
            moveClone(e.touches[0].clientX, e.touches[0].clientY);
        }

        function handleTouchEnd(e) {
            if (!draggedItem) return;
            clone.style.display = 'none';
            const dropTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            document.body.removeChild(clone);
            clone = null;

            if (dropTarget && dropTarget.classList.contains('drop-zone')) {
                handleDrop({ preventDefault: () => {}, currentTarget: dropTarget });
            }
        }
        
        function moveClone(x, y) {
             if (clone) {
                clone.style.left = x - clone.offsetWidth / 2 + 'px';
                clone.style.top = y - clone.offsetHeight / 2 + 'px';
            }
        }

        function checkDragDropAnswer() {
            const currentQuestion = questions[currentQuestionIndex];
            checkDragButton.classList.add('hidden');
            let isCorrect = false;

            const isMobileView = window.getComputedStyle(dragDropContainerMobile).display !== 'none';
            const relevantDropZonesContainer = isMobileView ? dropZonesContainerMobile : dropZonesContainer;
            const zones = Array.from(relevantDropZonesContainer.querySelectorAll('.drop-zone'));

            if (currentQuestion.type === 'drag_drop_fill') {
                let correctCount = 0;
                zones.forEach(zone => {
                    const droppedItem = zone.children[0];
                    if (droppedItem && droppedItem.classList.contains('draggable-item') && droppedItem.id === zone.dataset.correctId) {
                        zone.classList.add('bg-green-200', 'border-green-400');
                        correctCount++;
                    } else {
                        zone.classList.add('bg-red-200', 'border-red-400');
                    }
                });
                isCorrect = correctCount === currentQuestion.items.length;
            } else { // 'drag_drop'
                const finalOrder = zones.map(zone => zone.children[0] && zone.children[0].classList.contains('draggable-item') ? zone.children[0].id : null);
                isCorrect = JSON.stringify(finalOrder) === JSON.stringify(currentQuestion.correctOrder);
                
                zones.forEach((zone, index) => {
                    const droppedItem = zone.children[0];
                    if(droppedItem) {
                       const droppedId = droppedItem.id;
                       if (isCorrect || droppedId === currentQuestion.correctOrder[index]) {
                           zone.classList.add('bg-green-200', 'border-green-400');
                       } else {
                           zone.classList.add('bg-red-200', 'border-red-400');
                       }
                    } else if (!isCorrect) {
                        zone.classList.add('bg-red-200', 'border-red-400');
                    }
                });
            }

            if (isCorrect) {
                score += 10;
                playSound(true);
            } else {
                playSound(false);
            }
            updateScore();
            showPostAnswerButtons();
        }

        function updateScore() {
            scoreText.textContent = `ƒêi·ªÉm: ${score}`;
        }

        function showEndScreen() {
            showScreen('end');
            finalScore.textContent = score;
            launchConfetti();
        }
        
        function launchConfetti() {
            confettiContainer.innerHTML = '';
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.animationDuration = Math.random() * 2 + 3 + 's';
                confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
                confetti.style.transform = `scale(${Math.random() + 0.5})`;
                confettiContainer.appendChild(confetti);
            }
        }

        // --- Event Listeners ---
        startButton.addEventListener('click', () => {
            setupAudio();
            showScreen('instructions');
        });
        playButton.addEventListener('click', startGame);
        restartButton.addEventListener('click', () => {
            confettiContainer.innerHTML = '';
            showScreen('start');
        });
        checkDragButton.addEventListener('click', checkDragDropAnswer);
        
        explanationButton.addEventListener('click', () => {
            explanationText.innerHTML = questions[currentQuestionIndex].explanation;
            explanationModal.classList.remove('hidden');
        });

        closeExplanationModal.addEventListener('click', () => {
            explanationModal.classList.add('hidden');
        });

        nextQuestionButton.addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion();
        });

    </script>
</body>
</html>
